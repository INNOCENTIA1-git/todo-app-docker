name: Pull Request Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  # Lint Dockerfile
  dockerfile-lint:
    name: Lint Dockerfile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

  # Check docker-compose syntax
  compose-validate:
    name: Validate docker-compose.yml
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose file
        run: docker-compose config

  # Check for common issues
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for trailing whitespace
        run: |
          if git diff --check HEAD^..HEAD; then
            echo "No trailing whitespace found"
          else
            echo "Trailing whitespace detected"
            exit 1
          fi

      - name: Check file size
        run: |
          find . -type f -size +10M -not -path "./.git/*" -exec ls -lh {} \; | awk '{print $9 ": " $5}' || true

  # Size comparison
  image-size-check:
    name: Docker Image Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image
        run: docker build -t size-check:latest .

      - name: Check image size
        run: |
          SIZE=$(docker images size-check:latest --format "{{.Size}}")
          echo "Image size: $SIZE"
          # Alert if image is larger than 300MB
          SIZE_MB=$(docker images size-check:latest --format "{{.Size}}" | sed 's/MB//')
          if (( $(echo "$SIZE_MB > 300" | bc -l) )); then
            echo "⚠️  Warning: Image size exceeds 300MB"
            echo "Consider optimization techniques"
          else
            echo "✅ Image size is acceptable"
          fi